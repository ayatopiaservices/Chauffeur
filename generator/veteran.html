<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generátor smlouvy na prohlídku</title>
    <!-- Tailwind CSS CDN pro moderní a responzivní design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import fontů, které se nejvíce podobají originálnímu dokumentu */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Times+New_Roman:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        /* Styly pro dialogové okno s chybovou zprávou */
        .message-box {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .message-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
        }
        /* Styly pro generovaný dokument */
        .contract-box {
            background-color: #ffffff;
            padding: 2.5rem;
            line-height: 1.5;
        }
        #page1 {
            font-family: 'Times New Roman', serif;
            font-size: 7pt;
            line-height: 1.2; /* Snížení řádkování */
        }
        #page1 .title {
            font-size: 12pt;
        }
        #page1 .subtitle {
            margin-top: 0.5rem; /* Zmenšená mezera */
            margin-bottom: 30px;
        }
        #page2 {
            font-family: 'Tahoma', sans-serif;
            font-size: 9pt;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 297mm;
        }
        #page2 .title {
            font-size: 12pt;
        }
        #page2 .subtitle {
            margin-top: 0.5rem; /* Zmenšená mezera */
            margin-bottom: 30px;
        }
        #contract-output {
            width: 210mm;
            padding: 20mm;
            box-sizing: border-box;
            background-color: #ffffff;
        }
        .text-section {
            margin-bottom: 1rem;
        }
        .text-section p, .text-section div {
            margin: 0;
            padding: 0;
        }
        /* Page break pro tisk */
        .page-break {
            page-break-after: always;
        }

        /* Styly pro správnou velikost písma v PDF */
        @media print {
            #page1 {
                font-size: 7pt;
            }
            #page1 .title {
                font-size: 12pt;
            }
            #page2 {
                font-size: 9pt;
            }
            #page2 .title {
                font-size: 12pt;
            }
        }

        /* Styly pro podpisovou plochu */
        .signature-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none; /* Skryto ve výchozím stavu */
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        .signature-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #signature-pad {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            cursor: crosshair;
        }
        .signature-image {
            width: 150px;
            height: 100px;
        }
        .signature-placeholder {
            width: 150px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .signature-line {
            border-bottom: 1px solid black;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Generátor smlouvy na prohlídku</h1>
        <form id="contract-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="datetime" class="block text-sm font-medium text-gray-700 mb-1">Datum a čas (dd.mm.yyyy hh:mm):</label>
                <input type="datetime-local" id="datetime" class="form-input" required>
            </div>
            <div>
                <label for="client" class="block text-sm font-medium text-gray-700 mb-1">Objednatel (Jméno):</label>
                <input type="text" id="client" class="form-input" required>
            </div>
            <div>
                <label for="pickupLocation" class="block text-sm font-medium text-gray-700 mb-1">Místo nástupu:</label>
                <input type="text" id="pickupLocation" class="form-input" required>
            </div>
            <div>
                <label for="tourDuration" class="block text-sm font-medium text-gray-700 mb-1">Doba trvání prohlídky:</label>
                <select id="tourDuration" class="form-input" required>
                    <option value="" disabled selected>Vyberte dobu trvání</option>
                    <option value="30">30 minutes</option>
                    <option value="40">40 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>
            <div>
                <label for="priceGuidedTour" class="block text-sm font-medium text-gray-700 mb-1">Cena prohlídky (EUR):</label>
                <input type="number" id="priceGuidedTour" class="form-input" required min="15">
            </div>
            <div>
                <label for="numPersons" class="block text-sm font-medium text-gray-700 mb-1">Počet osob:</label>
                <input type="number" id="numPersons" class="form-input" required min="1">
            </div>
            <div>
                <label for="driver" class="block text-sm font-medium text-gray-700 mb-1">Řidič:</label>
                <select id="driver" class="form-input" required>
                    <option value="" disabled selected>Vyberte řidiče</option>
                    <option value="Jakub Horák">Jakub Horák</option>
                    <option value="Dalibor Muczka">Dalibor Muczka</option>
                </select>
            </div>
            <div>
                <label for="spz" class="block text-sm font-medium text-gray-700 mb-1">SPZ:</label>
                <select id="spz" class="form-input" required>
                    <option value="" disabled selected>Vyberte SPZ</option>
                    <option value="4AX8079">4AX8079</option>
                    <option value="4AI2333">4AI2333</option>
                </select>
            </div>
            <div class="md:col-span-2 flex justify-center mt-4 space-x-4">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors">Generovat smlouvu</button>
                <button type="button" id="sign-button" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transition-colors">Podepsat</button>
            </div>
        </form>

        <div id="contract-container" class="hidden">
            <div id="contract-output"></div>
            <div class="flex justify-center mt-4 space-x-4">
                <button id="save-pdf-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-colors">Uložit jako PDF</button>
            </div>
        </div>
    </div>

    <!-- Modální okno pro podpis -->
    <div id="signature-modal" class="signature-modal">
        <div class="signature-content">
            <h2 class="text-lg font-bold mb-2">Podepište zde</h2>
            <canvas id="signature-pad" width="400" height="200"></canvas>
            <div class="flex justify-between mt-4">
                <button id="clear-signature" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors">Vyčistit</button>
                <button id="save-signature" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Uložit a vygenerovat smlouvu</button>
            </div>
        </div>
    </div>
    
    <!-- Knihovny pro generování PDF a podpis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('contract-form');
            const contractContainer = document.getElementById('contract-container');
            const contractOutput = document.getElementById('contract-output');
            const savePdfButton = document.getElementById('save-pdf-button');
            const datetimeInput = document.getElementById('datetime');
            const signButton = document.getElementById('sign-button');
            const signatureModal = document.getElementById('signature-modal');
            const signaturePadElement = document.getElementById('signature-pad');
            const clearSignatureButton = document.getElementById('clear-signature');
            const saveSignatureButton = document.getElementById('save-signature');

            // Globální proměnná pro podpis
            let customerSignatureImage = null;

            // URL obrázku s podpisem poskytovatele
            const providerSignatureUrl = 'https://ayatopia.com/generator/vintage_signature.png';
            let providerSignatureImage = null;

            // Inicializace SignaturePad
            const signaturePad = new SignaturePad(signaturePadElement);

            // Nastavení aktuálního data a času
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const formattedDatetime = `${year}-${month}-${day}T${hour}:${minute}`;
            datetimeInput.value = formattedDatetime;

            // Načtení obrázku s podpisem poskytovatele
            async function fetchAndEmbedImage(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Nepodařilo se načíst obrázek.');
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error('Chyba při načítání obrázku:', error);
                    return null;
                }
            }
            
            async function init() {
                providerSignatureImage = await fetchAndEmbedImage(providerSignatureUrl);
            }
            init();

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                generateContract();
            });

            signButton.addEventListener('click', () => {
                if (form.checkValidity()) {
                    signatureModal.style.display = 'flex';
                    signaturePad.clear();
                } else {
                    showMessage('Prosím, vyplňte všechna pole, než budete pokračovat k podpisu.');
                }
            });

            clearSignatureButton.addEventListener('click', () => {
                signaturePad.clear();
            });

            saveSignatureButton.addEventListener('click', () => {
                if (signaturePad.isEmpty()) {
                    showMessage('Plocha pro podpis je prázdná. Prosím, podepište se.');
                } else {
                    customerSignatureImage = signaturePad.toDataURL('image/png');
                    signatureModal.style.display = 'none';
                    generateContract(customerSignatureImage);
                }
            });

            savePdfButton.addEventListener('click', async () => {
                await saveContractAsPdf();
            });

            // Funkce pro zobrazení vlastní dialogové zprávy
            function showMessage(message) {
                const messageBox = document.createElement('div');
                messageBox.className = 'message-box';
                messageBox.innerHTML = `
                    <div class="message-content">
                        <p class="text-lg font-semibold text-gray-800">${message}</p>
                        <button onclick="this.parentNode.parentNode.remove()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }

            // Funkce pro generování obsahu smlouvy
            async function generateContract(signatureImage = null) {
                const datetime = datetimeInput.value;
                const client = document.getElementById('client').value;
                const pickupLocation = document.getElementById('pickupLocation').value;
                const tourDuration = document.getElementById('tourDuration').value;
                const priceGuidedTourEuro = parseFloat(document.getElementById('priceGuidedTour').value);
                const numPersons = document.getElementById('numPersons').value;
                const driver = document.getElementById('driver').value;
                const spz = document.getElementById('spz').value;

                if (!datetime || !client || !pickupLocation || !tourDuration || isNaN(priceGuidedTourEuro) || priceGuidedTourEuro <= 14 || !numPersons || !driver || !spz) {
                    showMessage('Prosím, zadejte částku vyšší než 14 EUR a vyplňte všechna pole.');
                    return;
                }

                // Převod ceny z EUR na CZK s kurzem 25 Kč/EUR
                const priceGuidedTourCZK = (priceGuidedTourEuro * 25) - 400;
                const overallPrice = priceGuidedTourCZK + 400;

                const dateObj = new Date(datetime);
                const issuedDate = `${String(dateObj.getDate()).padStart(2, '0')}. ${String(dateObj.getMonth() + 1).padStart(2, '0')}. ${dateObj.getFullYear()}`;
                const issuedContractNumber = `${dateObj.getFullYear()}${String(dateObj.getMonth() + 1).padStart(2, '0')}${String(dateObj.getDate()).padStart(2, '0')}${String(dateObj.getHours()).padStart(2, '0')}${String(dateObj.getMinutes()).padStart(2, '0')}`;
                
                let customerSignatureHTML = `
                    <div class="signature-placeholder">
                        <div class="signature-line"></div>
                        <div style="font-size: 7pt; margin-top: 5px; text-align: center;">(signature)</div>
                    </div>
                `;
                if (signatureImage) {
                    customerSignatureHTML = `<img src="${signatureImage}" alt="Podpis zákazníka" class="signature-image">`;
                }
                
                const providerSignatureHTML = `<img src="https://ayatopia.com/generator/vintage_signature.png" alt="Podpis pro Vintage Prague Sightseeing s.r.o." style="width: 150px; height: auto;">`;


                const contractHtml = `
                <!-- Guided Tour Contract - Page 1 -->
                <div class="contract-box" id="page1">
                    <div class="title" style="text-align: center; font-weight: bold; margin-bottom: 0;">Guided Tour Contract</div>
                    <div class="subtitle" style="text-align: center; font-style: italic; font-size: 7pt; margin-top: 0.5rem; margin-bottom: 30px;">(hereinafter the "Contract")</div>
                    
                    <div style="margin-bottom: 10px; margin-top: 0;">Concluded by and between the following Parties:</div>
                    <div style="height: 10pt;"></div> <!-- Prázdný řádek pro mezeru -->

                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold;">Guided Tour Provider:</div>
                        <div>
                            Name: Vintage Prague Sightseeing s.r.o.<br>
                            Address: Rybná 716/24, Staré Město, 110 00 Praha<br>
                            Company ID: 21506531
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold;">Customer:</div>
                        <div>
                            Name: ${client}<br>
                            Address: not specified<br>
                            Date of birth: not specified
                        </div>
                    </div>

                    <div style="text-align: center;"><span style="font-weight: bold;">I.</span></div>
                    <div style="margin-bottom: 5px;">By this Contract, the Guided Tour Provider agrees to provide guided tour services to the Customer under the conditions and terms hereunder, and the Customer undertakes to pay the agreed amount to the Guided Tour Provider for rendered services.</div>

                    <div style="text-align: center;"><span style="font-weight: bold;">II.</span></div>
                    <div style="margin-bottom: 5px;">Under this Contract, the Guided Tour Provider shall:</div>
                    
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">2.1.</span> Provide transportation to the Customer and accompany the Customer in accordance with the itinerary established by the Guided Tour Provider and ordered by the Customer.
                    </div>
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">2.2.</span> Provide the Customer with commentary on cultural, historical and natural heritage.
                    </div>
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">2.3.</span> Provide the Customer with basic information during the tour, including any practical information relating to the tour.
                    </div>
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">2.4.</span> Provide the Customer with basic assistance during the tour.
                    </div>

                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">3.</span> The Guided Tour Provider undertakes to provide the Customer with services as specified in Article 2 of this Contract on the following tour route duration/name:
                        <div style="margin-left: 20px; margin-top: 5px;">Tour route duration/name: ${tourDuration} minut</div>
                        <div style="margin-left: 20px; margin-top: 5px;">Date: ${issuedDate}</div>
                    </div>
                    
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">4.</span> The Guided Tour Provider is obliged to provide services as specified in Article II, Section 2, to the greatest possible extent. If certain parts of the tour itinerary cannot be observed by the Guided Tour Provider due to objective reasons, the Guided Tour Provider is entitled to change the itinerary in order to provide the Customer with the itinerary resembling as much as possible the one ordered by the Customer.
                    </div>
                    
                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">5.</span> In performing the services as specified in Article 2 of this Contract, the Guided Tour Provider may use an authorized person handling the provided services.
                    </div>

                    <div style="text-align: center;"><span style="font-weight: bold;">III.</span></div>

                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">6.</span> The Customer shall pay the fee for the rendered services under this Contract in amount specified in Article III.
                    </div>
                    
                    <div style="margin-bottom: 5px;">
                        <span>This Contract also serves as a tax receipt. The fee for the services shall be as follows:</span>
                        <div style="margin-left: 20px; margin-top: 5px;">Item: Guided tour with transportation</div>
                        <div style="margin-left: 20px; margin-top: 5px;">Price for guided tour: ${priceGuidedTourCZK},- Kč incl. VAT</div>
                        <div style="margin-left: 20px; margin-top: 5px;">Price for transportation: 400,- Kč incl. VAT</div>
                        <div style="margin-left: 20px; margin-top: 5px;">Number of persons: ${numPersons}</div>
                        <div style="margin-left: 20px; margin-top: 5px;">Overall: ${overallPrice},- Kč</div>
                    </div>

                    <div style="text-align: center;"><span style="font-weight: bold;">IV.</span></div>

                    <div style="margin-bottom: 5px;">
                        <span style="font-weight: bold;">8.</span> This Contract has been executed in English language and shall be governed by the laws of the Czech Republic.
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                        <div style="display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                            <span style="font-weight: bold;">Customer:</span>
                            ${customerSignatureHTML}
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start; text-align: left;">
                            <span style="font-weight: bold;">Guided Tour Provider:</span>
                            <img src="https://ayatopia.com/generator/vintage_signature.png" alt="Podpis pro Vintage Prague Sightseeing s.r.o." style="width: 150px; height: auto; margin-top: 20px;">
                        </div>
                    </div>
                </div>

                <!-- Confirmation of Transport Section - Page 2 -->
                <div class="contract-box page-break" id="page2">
                    <div>
                        <p style="text-align: right; margin-bottom: 20px;">Vystaveno ${issuedDate}</p>
                        <div class="title" style="text-align: center; font-weight: bold; margin-bottom: 0;">Potvrzení o přepravě č. ${issuedContractNumber}</div>
                        <div class="subtitle" style="text-align: center; font-style: italic; font-size: 9pt; margin-top: 0.5rem; margin-bottom: 30px;">(Confirmation of transport)</div>
                        
                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Dopravce/Carrier:</span><br>
                            Vintage Prague Sightseeing s.r.o.<br>
                            Rybná 716/24, Staré Město, 110 00 Praha<br>
                            IČO: 21506531
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Řidič/Driver:</span><br>
                            ${driver}<br>
                            Mercedes-Benz 770<br>
                            <span style="font-weight: bold;">SPZ:</span> ${spz}
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Objednatel/Client:</span><br>
                            ${client}
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Trasa/Route:</span><br>
                            Okružní jízda Prahou dle sjednaného itineráře/Prague sightseeing tour according to the agreed itinerary.
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Doba trvání přepravy:</span><br>
                            ${tourDuration} minut
                        </div>

                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Konec přepravy/Destination:</span><br>
                            ${pickupLocation}, Praha
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <span style="font-weight: bold;">Cena celkem/Total Price:</span><br>
                            400,- Kč
                        </div>
                    </div>
                </div>
                `.trim();

                contractOutput.innerHTML = contractHtml;
                contractContainer.classList.remove('hidden');
            }

            // Funkce pro uložení smlouvy jako PDF s podporou více stránek
            async function saveContractAsPdf() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const page1 = document.getElementById('page1');
                const page2 = document.getElementById('page2');
                
                // Převod první stránky
                const canvas1 = await html2canvas(page1, { scale: 3, logging: false, useCORS: true, backgroundColor: '#ffffff' });
                const imgData1 = canvas1.toDataURL('image/png');
                const imgProps1 = doc.getImageProperties(imgData1);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight1 = (imgProps1.height * pdfWidth) / imgProps1.width;
                doc.addImage(imgData1, 'PNG', 0, 0, pdfWidth, pdfHeight1);
                
                // Přidání nové stránky a převod druhé stránky
                doc.addPage();
                const canvas2 = await html2canvas(page2, { scale: 3, logging: false, useCORS: true, backgroundColor: '#ffffff' });
                const imgData2 = canvas2.toDataURL('image/png');
                const imgProps2 = doc.getImageProperties(imgData2);
                const pdfHeight2 = (imgProps2.height * pdfWidth) / imgProps2.width;
                doc.addImage(imgData2, 'PNG', 0, 0, pdfWidth, pdfHeight2);

                const dateObj = new Date(datetimeInput.value);
                const issuedContractNumber = `${dateObj.getFullYear()}${String(dateObj.getMonth() + 1).padStart(2, '0')}${String(dateObj.getDate()).padStart(2, '0')}${String(dateObj.getHours()).padStart(2, '0')}${String(dateObj.getMinutes()).padStart(2, '0')}`;
                doc.save(`${issuedContractNumber}.pdf`);
            }
        });
    </script>
</body>
</html>
